iis ftp 漏洞.

http://os.51cto.com/art/201012/239821_all.htm


提高IIS的FTP安全性   使用足够隐蔽的端口进行通信




“端口”设置建议不使用默认端口，而是将默认端口设置成一个不常用的，大于10000、小于65535的端口号。之所以要设置大于10000，小于65535是因为很多端口扫描工具默认情况下都不会扫描这部分端口，而攻击者如果手动设置扫描端口的话，出于时间和速度的考虑，也很少定义1-65535这样的端口扫描规则，所以很容易迷惑攻击者，让他们根本不知道原来还有一个高端端口隐蔽在系统中发挥作用。

即使攻击者用扫描器扫到了这个端口，往往也会因为这个陌生的端口而不明白具体运行的服务，需要详细探测才有可能发现是FTP服务。接下来，将对此新建的FTP服务器进行详细的安全配置。


IIS的FTP系统有非常完善、丰富的日志记录系统，使用日志系统来时刻记录FTP服务器的运行状态是非常重要的。

1．启用FTP服务器的日志记录功能

在默认情况下，IIS管理器下FTP站点中的某个站点的FTP日志系统默认是启用的。

2．FTP服务器的高级日志配置

和普通的FTP服务器要求不同，如果需要建立足够安全的FTP服务器，需要对日志系统进行详细的高级定义，定义的内容就是设置攻击者或者可能发生的攻击可能存在的典型特征。






需要注意的是，并不是日志系统记录的信息越多就越好，因为日志系统记录FTP用户（攻击者或者正常用户）的访问毕竟需要消耗资源，而且生成的日志记录同样需要存放空间。如果记录项目过多，可能引起系统资源消耗日志文件占用空间大的问题。




真经第三重点穴篇——取消匿名访问

匿名访问是FTP服务器的默认设置，此设置可以很好地支持普通用户的FTP访问，但是要建立安全性足够的FTP服务器的话，此项设置必须去除。




真经第四重摧心掌——强制安全密码规则

在有意无意之中，一些用户的FTP账号密码设置得过于简单，为了提高FTP服务器的安全性，特别是需要建立安全性足够强的维护型FTP服务器，必须强制用户设置复杂的账号密码。



1．组策略简介

在Windows系统中，密码的规则设置是由组策略所控制的。简单地说，组策略设置就是在修改注册表中的配置。当然，组策略使用了萄託每的管理组织方法，可以对各种对象中的设置进行管理和配置，远比手工修改注册表方便、灵活，功能也更加强大。

依次指向“开始一运行”，输入“gpedit.msc”进入Windows 2003 Server系统的组策略选项。进入组策略选项以后，在左方快速链接栏中依次指向“计算机配置一〉Windows设置一〉账户策略一〉密码策略”，这里可以设置很多密码的相关安全规则。

在右侧矿体中找到“密码必须符合复杂性要求”项，然后双击打开后，选中“已启用”按钮，最后单击确定使之生效。



如果启用“密码必须符合复杂性要求”策略，在更改或创建账户（密码）时就会执行复杂性策略检查，密码必须符合下列最低要求：

a.密码不能包含账户名：

b.密码不能包含用户名中超过两个连续字符的部分：

c.密码至少有6个字符长度；

d.策略包含以下4类字符中的至少3类字符：英文大写字母(A-Z)、英文小“．写字母(a-z)、10个基本数字(0-9)、特殊字符（例如！、$、#、%）

3．启用密码长度最小值策略

另外，更具安全密码规则中密码长度的要求，可以双击“密码长度最小值”进行最小密码长度的设置。例如把最小长度设置为8个字符，经过这样的设置，FTP用户（乃至系统用户）的密码安全性就大大地提高了，系统安全性也就大大增强了。



维护型的FTP服务器使用者一般是网络管理员，所以不存在大量用户使用的问题，一般都是机构管理员在分别使用。

针对这样的情况，如果采用IIS下的FIP Server构建服务器的话，首先应该考虑的是去掉默认FTP服务器中的匿名访问，然后建立专用的FTP账户，最后为专用的FTP账户指派访问目录。

1．建立专用FTP账户

假定有5个管理员需要对服务器进行经常性的维护，而且各自的工作职能不同，那就需要建立至少5个专用FTP账户。



Net user ft01 pass11@! wd /add

重复上述用户建立设置，依次建立ftp01~ftp05等几个账户。

2．建立专用账户对应的FTP文件夹

建立好FTP专用账户以后，需要为专用账户指派FTP目录，以系统管理员身份找到n（y的根文件夹，分别为每个用户建立一个对应的文件夹，例如用户ftp01就对应ftp01文件夹、ftp02用户对应ftp02文件夹。

真经高手阶段

上述几个步骤只是简单地建立了几个可用账户，远远没有达到实现安全FTP的目的，下述内容将进行详细设置。

真经第六重九阴白骨爪——使用NTFS约束FTP用户权限

在管理员各自对应的FTP用户建立好之后，并不能直接使用，需要对各账户进行详细的权限设置。




删除各FTP文件夹继承权限

以ftp01账户对应的ftp01文件夹为例，以系统管理员身份登录，选中文件夹并右键选择“安全”选项卡，默认情况下这里有非常多的已经继承于上级文件夹的权限，

我们需要做的是删掉这些默认的权限，但是在删除的时候会出现系统提示：

因为“SYSTEM”从其父系继承权限，您无法删除此对象。要删除“SYSTEM 

“必须阻止对象继承权限。关闭继承权限的选项，然后重试删除“SYSTEM”

因为权限是继承上级文件夹的，所以不能直接删除，需要单击“高级”按钮，进入此文件夹的“高级安全设置”，






对广大直面各种网络攻击的网络安全工程师来说，工作中必然会遇到会遇到各种各样的FTP攻击，普通管理员会认为Windows 下FTP服务安全性比较弱，安全性无法保证，所以在Windows server加装了第三方FTP 程序，以满足自己的要求。














弱口令扫描主机. 得到ftp

虽然我们通过刚才的步骤得到了大量存在FTP弱口令的主机，但并不表明它们都可以被入侵.因为他们的FTP服务器类型还没确定.可能是微软的FTP.或者是WUFTP等等.


nessus 来确定对方的 ftp类型.
220-Microsoft FTP Service



nessus 有很多插件..    ftp插件也有..




步骤3:很快扫描完毕.详细显示了被扫描主机的FTP服务器类型.可以看出有台目标主机的FTP服务器类型为:serv-u FTP


通过刚才的扫描等一系列步骤.我已经确定了要下手的目标.
下面，开始使用serv-u MDTM溢出漏洞进行入侵.
步骤1:在命令行下运行serv-u MDTM溢出的利用程序killftp.察看到帮助文件
步骤2:按照提示.我们输入命令:killftp 218.109.2.222 21 ftp ftp. 即对一台IP为218.109.2.222，帐号为FTP.密码为FTP的主机进行攻击，
可以看出，提示成功之后连接8111端口
步骤3:按照成功提示.我们利用NC端口程序连接目标主机的8111端口，输入连接命令: nc -vv 218.109.2.222 8111 很快就可以得到一个新的
DOS窗口.而且这个窗口还是管理员权限的.就这么简单



三、后门旋转保留肉鸡
通过.刚才的方法进入了服务器内部，但是要保住这台肉鸡，还真有点困难.
一是.可能它是动态I定次重新启动之后就丢了，或者是对方管理员很警觉.不让你有丝毫留后门的机会. 那么该怎么办呢?我向大家推荐一款非
常好的后门工具来解决难题，web my pc是一款自动上线的远程管理软件.本来是为了管理员远程管理主机之用，它具有自动上线，连接速度快，
可以直接浏览器中操作的特点.不需要任何外接软件.刚才的那台肉鸡存在terminal server(远程终端服务).我很容易通过连接就进入到其内部
下面在图形界面下将web my pc安装成为后门.步骤1:在肉鸡上打开web my pc的主程序进行设置.先填写登录名称和密码，这需要注册，因为web my pc是一家公司提供的服务，要想使用它，必须
先注册.
步骤2:接下来在web my pc的主程序中填写上登录名称，密码等相关信息，设置完毕.即可开始运行.在运行时屏幕右下角的任务栏会显示其图标. 步骤3:在右下角任务栏显示的图标上点鼠标右键，选择"安装为windows服务"，这样就可以将web my pc安装为系统服务.
可以找到服务:webmypc server.将其启动类型设置为"自动"并启动服务即可.
这样彻底将服务安装完毕.以后每次就会随机启动.
步骤4:在右下角任务栏显示的图标非常的碍眼.很容易让管理员发现，所以必须将它去掉，方法是:点"开始"，"运行"，输入regedit.打开注册表，
进入路径为 HKEY_LOCAL_MACHINE\\software\\mirosoft\\windows\\currentversion\\run 将webmypc的启动键值.webmypc删除掉即可.这样就不
会在右下角任务栏显示出图标了
步骤5:一切设置完毕之后，就可以登录网站:http://dns0755.net填写申请的用户名和密码进入，然后点"自助服务"项目，可以在那里找
到上线的肉鸡.名字叫:黑蛋.这样就可以远程控制它了.
这样利用这个漏洞以及介绍的后门webmypc，完全可以搞大量的肉鸡，而且不会担心肉鸡丢失，实在是机不可失。


