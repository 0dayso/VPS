🔵 Zabbix 简介: 

    - 企业级的 CPU、内存、硬盘、网络、端口、日志的 监视软件.用网页来监控系统状态.实时绘图: 更直观显示服务器状态.
    - 支持主流 Linux、Mac OS . 但是 Windows 只能跑客户端!!!!!

    - 软件版本: 
      - LTS: Long Time Support 长期支持.
      - Zabbix 3.0 LTS  2016 2.16 发行. 2017-04-14-12 最新版应该是 3.2.4

    - 触发器(trigger):  CPU 达到 90% 自动发邮件给你警告

    Zabbix 组成: Server 监控端 + Agent (被监控端);
    源代码压缩包只有一个: 包含了 Server + Agent.  编译的时候 按需求选择安装就好了.

    zabbix server可以通过SNMP，zabbix agent，ping，端口监视等方法提供对远程服务器/网络状态的监视，数据收集等功能，

    服务端:  需要安装 zabbix、web服务器(Nginx/Apache)、数据库(mysql/postsql...)、php
    客户端:  需要安装 zabbix3.2.4
    安装过程建议关闭防火墙.   service iptables stop



🔵 zabbix 进程结构:
    zabbix_agentd
    zabbix_get
    zabbix_proxy
    zabbix_sender
    zabbix_server
    zabbix_java_gateway (可选)

    进程介绍:
      
    zabbix_agentd
        客户端守护进程，收集客户端数据，如cpu、内存、硬盘使用使用情况.

    zabbix_get
        获取被监控客户端信息的命令,常用于排错。

    zabbix_sender
        发送数据给server或者proxy，通常用于耗时比较长的检查。
        脚本执行完毕之后，使用sender主动提交数据。

    zabbix_server
        服务端守护进程。所有数据最终都是提交到server
        备注：有些数据主动交给server,也有的是server主动去获取数据。

    zabbix_proxy
        代理守护进程。功能类似server，唯一不同的是它只是一个中转站.
        它需要把收集到的数据提交/被提交到server里。




❤️ 服务端( VPS Centos6 )安装
    🔸 一定要先安装依赖组件,不然报错. 会编译不成功
    yum install net-snmp-devel libxml2-devel libcurl-devel 

    🔸 下载源代码到 src .
    cd /usr/local/src     ➜ 其实下载到哪里都可以. 注意安装路径就可以了. 一般都是下载到src文件夹的.
      ➜ 去官网下载最新版本的源代码:  http://www.zabbix.com/download
      ➜ zabbix Sources ➜  zabbix 3.2 ➜  点进去等几秒会开始下载. 
      ➜ 去浏览器 找出这个下载的真实地址 ➜  然后用 wget + 地址 下载到服务器....
      Zabbix server一般充当两个角色：server、angent， 
      所以下面编译的时候也同时加上了--enable-agent。

        wget https://superb-sea2.dl.sourceforge.net/project/zabbix/ZABBIX%20Latest%20Stable/3.2.4/zabbix-3.2.4.tar.gz
        tar xf zabbix-3.2.4.tar.gz && cd zabbix-3.2.4
        ./configure --prefix=/usr/local/zabbix-server --enable-server --with-mysql --with-net-snmp --with-libcurl --with-libxml2 --enable-agent
        make && make install



🔵 创建zabbix 用户/用户组
    为了安全考虑zabbix只使用普通用户运行，
    假如你当前用户是ttlsa，那么你运行他，他便使用ttlsa身份运行。
    假如你当前用户是root  那么zabbix将会主动使用zabbix用户来运行。
    但是如果你的系统没有名叫zabbix的用户，你需要创建一个zabbix用户和zabbix用户组
    groupadd zabbix
    useradd -g zabbix zabbix


🔵 创建zabbix数据库
    zabbix server服务器端需要数据库，angent被监控端不需要。
    尤其要注意的是proxy只需要导入一个sql文件(多导入会报错!)，而server一共要导入3个sql文件。

    假设:你安装好了MySQL，用户名为root，密码为ttlsapwd
    mysql -uroot -pxujian                         ➜ 来进入服务器的数据库. (首先ssh进服务器.)
    create database zabbix default charset utf8;  ➜ 创建数据库, 加default charset utf8，不然中文乱码，
    quit;                                         ➜ 退出mysql. 这里目的只要创建一个zabbix 名称的数据库

🔵 导入sql文件.
    下面需要进入解压出来的zabbix文件夹内进行后续操作: 也就是导入三个sql文件. 
    cd /usr/local/src/zabbix-3.2.4
    mysql -uroot -pxujian0219 zabbix < database/mysql/schema.sql
    mysql -uroot -pxujian0219 zabbix < database/mysql/images.sql
    mysql -uroot -pxujian0219 zabbix < database/mysql/data.sql


    👹 ERROR 1071 (42000) at line 1476: Specified key was too long; max key length is 1000 bytes
        如果遇到这个报错 就说明索引太长了. 默认最长值 1000bytes.
        你数据库引擎用的是 MyISAM引擎, 建议换innodb引擎.
        Innodb 引擎性能好很多.. 很多软件必须用 innodb 引擎不然就报错.
        📌 升级前必须备份数据库...如果有资料的话..
        MyISAM是MySQL5.5之前版本默认的数据库存储引擎。
        InnoDB是MySQL5.6版本的默认数据库存储引擎，

        📌📌 最简单的解决方法就是备份5.5 的数据库. 然后升级都5.6/5.7 然后再数据恢复.
        一键脚本升级mysql很慢的. 起码一个小时...
        如果你的服务器 内存小于1G... 那是没办法安装 5.6 版本的....
        那就只能 在mysql 5.5 上面想办法了...
        
        首先登录 myslq 命令行交互界面.
        🔅 show engines;        ➜  查看当前支持的引擎. innodb后面是 no.. 说明不支持.配置下 my.cnf 来支持 innodb  
        🔅 service mysql stop   ➜  首先关闭mysql服务.

        🔅 vi /etc/my.cnf       ➜  修改my.cnf 文件
            default-storage-engine=MyISAM    这行注释掉.  
            default-storage-engine=INNODB    添加这一行.

            下面几行全部取消前面的注释
            innodb_data_home_dir = /usr/local/mysql/var
            innodb_data_file_path = ibdata1:10M:autoextend
            innodb_log_group_home_dir = /usr/local/mysql/var
            innodb_buffer_pool_size = 16M
            innodb_additional_mem_pool_size = 2M
            innodb_log_file_size = 5M
            innodb_log_buffer_size = 8M
            innodb_flush_log_at_trx_commit = 1
            innodb_lock_wait_timeout = 50


        🔅 service mysql start ➜  重启服务   

        👹 Starting MySQL.The server quit without updating PID file (/[FAILED]l/mysql/var/mail.0214.help.pid).
        重启不了. 报错了. 别急. 有问题都是会有日志的!!! 日志里面会有详细原因.
        📌📌 日志在 /usr/local/mysql/var 下面. 里面肯定有个 mail.0214.help.err
        我们来看  mail.0214.help.err
            170414 17:35:51 mysqld_safe Starting mysqld daemon with databases from /usr/local/mysql/var
            170414 17:35:51 [Note] /usr/local/mysql/bin/mysqld (mysqld 5.5.48-log) starting as process 2538 ...
            170414 17:35:51 [Note] Plugin 'FEDERATED' is disabled.
            ➜ 170414 17:35:51 [Note] Plugin 'InnoDB' is disabled.
            ➜ 170414 17:35:51 [ERROR] Unknown/unsupported storage engine: INNODB
            170414 17:35:51 [ERROR] Aborting

            170414 17:35:51 [Note] /usr/local/mysql/bin/mysqld: Shutdown complete

            170414 17:35:51 mysqld_safe mysqld from pid file /usr/local/mysql/var/mail.0214.help.pid ended


        📌 Plugin 'InnoDB' is disabled.    说明 innodb 被禁用了啊!!!
        my.cnf 中 找到这行loose-skip-innodb
        在这行前面加个#号  注释掉这行 就可以启动 innodb 了!!!!  
        诶 这么简单的问题....再启动下就正常了... service mysql start

        下面就简单了. zabbix数据库删除. 重新建立. 这回应该默认使用innodb引擎了.



🔵 配置 zabbix

    vim /usr/local/zabbix-server/etc/zabbix_server.conf
        DBName=zabbix
        DBUser=root
        DBPassword=xujian0219
        DBPort=3306 “”

        
        我们只需要关注DBHost、DBName、DBUser、DBPassword几项即可。
        这几项是配置zabbix server连接mysql数据库的参数
        编辑文件. 把数据库/用户名/用户密码/数据库端口 改成你自己的.
        目的就是为了 zabbix 可以连接到 你在mysql中建立的zabbix数据库.
        一般只要改 用户名和密码就好了. 你可以用root 的账户密码. 反正root是对任何数据库都有权限的.



🔵 启动 Zabbix server  默认端口10051
/usr/local/zabbix-server/sbin/zabbix_server









🔵 zabbix网站配置

    如果你之前以及在服务器上用nginx搭建过网站了.
    那么 这里也推荐你继续用 nginx来搭建 zabbix.
    比如 我现在 服务器上 www.0214.help 是直接访问的 ss控制面板.
    这个www.0214.help首页 其实是在服务器的
    /home/wwwroot/www.0214.help/ss-panel/public/index.php

    那么我们现在想要通过 www.0214.help/zabbix 来访问zabbix的控制面板.
    值需要在 /home/wwwroot/www.0214.help/ss-panel/public/ 下新建一个zabbix文件夹.
    然后把
    zabbix 解压文件夹下的 forntends/php下的所有文件都 
    复制到 /home/wwwroot/www.0214.help/ss-panel/public/zabbix 就可以了!!!

    cp -r * /home/wwwroot/www.0214.help/ss-panel/public/zabbix

    现在浏览器输入 http://www.0214.help/zabbix  就进入zabbix 控制页面了.





❤️ Zabbix 管理页面
http://www.0214.help/zabbix/setup.php

分几步.
1. 检查环境. 
2. 连接数据库
3. zabbix 
..



🔵 一: 环境检测
    必须全部ok 才能next
    
    👹 PHP option "max_input_time"	60	300	Fail
        60 是当前设置.   300是zabbix需要的设置. 那么就去改...php的配置文件.

        http://23.105.192.96/phpinfo.php
        我是用一键安装包安装的 lnmp环境. 可以直接用上面的网页查看php详细情况.

        配置文件: 
        vi /usr/local/php/etc/php.ini
        找到 max_input_time  改成300 保存.
        然后重启php

        killall php-fpm 
        /usr/local/php-5.2.17/sbin/php-fpm start|stop  
        两种方法 随便选..

        然后再去 zabbix 页面 下一步...


🔵 二: 数据库配置
    Database type  mysql
    Database host  选择 localhost
    Database port  3306
    Database name  数据库名: zabbix
    账户密码  


    👹 The frontend does not match Zabbix database.
        如果你确保 信息没填错. 那么肯定是你导入3个数据库文件的时候有报错.你没处理.
        解决办法: 删除现有的 zabbix 数据库 .重新导入. 解决导入过程出现的任何错误!!



🔵 三: Zabbix server details
    Host localhost    
    Port 10051        ➜  zabbix服务端端口.       
    Name 可以不填.


🔵 四: 安装
  Cannot create the configuration file.
  可能是没有权限创建文件.  那就下载文件. 手动放到提示的路径中.
  Save it as "/home/wwwroot/www.0214.help/ss-panel/public/zabbix/conf/zabbix.conf.php"

🔵 五: 登录
  安装算是完成了. 自动跳转到登录界面...
  艹 登录帐号密码是什么啊... 数据库的root用户反正不多...
  默认账户: admin  默认密码: zabbix
  终于登录进去了 ....  一进去就发现网页底部有个提示
  zabbix server is not running... 


🔵 zabbix server is not running... 

    ./configure --prefix=/usr/local/zabbix-server
    zabbix 编译安装的时候 是加了参数 --prefix的. 也就是手动指定安装路径的.
        /usr/local/zabbix-server/sbin 下面有两个文件 
        -rwxr-xr-x 1 root root 927K Apr 14 11:55 zabbix_agentd
        -rwxr-xr-x 1 root root 3.1M Apr 14 11:55 zabbix_server
        按理说权限也是对的.. 

    /usr/local/zabbix-server/sbin/zabbix_server
    这个命令是启动服务器的. 为什么运行后. 不见有端口打开. 
    zabbix网页里面还是提示 zabbix server 服务没开启
    那就查看日志!!!! 日志在哪里呢! 看这个文件.
    vi /usr/local/zabbix-server/etc/zabbix_server.conf
    LogFile=/tmp/zabbix_server.log
    找到日志位置后 就是查看日志.
    vi /tmp/zabbix_server.log

    32252:20170414:110425.950 Starting Zabbix Server. Zabbix 3.2.4 (revision 65975).
    32252:20170414:110425.950 ****** Enabled features ******
    32252:20170414:110425.950 SNMP monitoring:           YES
    32252:20170414:110425.950 IPMI monitoring:            NO
    32252:20170414:110425.950 Web monitoring:            YES
    32252:20170414:110425.950 VMware monitoring:         YES
    32252:20170414:110425.950 SMTP authentication:        NO
    32252:20170414:110425.950 Jabber notifications:       NO
    32252:20170414:110425.950 Ez Texting notifications:  YES
    32252:20170414:110425.950 ODBC:                       NO
    32252:20170414:110425.950 SSH2 support:               NO
    32252:20170414:110425.950 IPv6 support:              YES
    32252:20170414:110425.950 TLS support:                NO
    32252:20170414:110425.950 ******************************
    32252:20170414:110425.950 using configuration file: /usr/local/zabbix-server/etc/zabbix_server.conf
    32252:20170414:110425.951 [Z3001] connection to database 'zabbix' failed: [2002] Can't connect to local MySQL server through socket '/var/lib/mysql/mysql.sock' (2)
    32252:20170414:110425.953 Got signal [signal:11(SIGSEGV),reason:1,refaddr:(nil)]. Crashing ...


    👹 using configuration file: /usr/local/zabbix-server/etc/zabbix_server.conf
      [Z3001] connection to database 'zabbix' failed:
        这个应该就是问题关键了.用 zabbix_server.conf 里面的配置 连不上数据库. 

        我们来看看 这个配置文件.
        这文件看着很长的. 丫的实际都是带#号. 都是注释说明. 没注释的不超过10行..
        重点么 也就 数据库名称. 数据库端口. 帐号密码..
        vi /usr/local/zabbix-server/etc/zabbix_server.conf

        LogFile=/tmp/zabbix_server.log
        DBHost=localhost
        DBName=zabbix
        DBUser=root
        DBPassword=xujian0219
        DBPort=3306          ➜  这个前面是有#号的. 必须手动删除 # 号.
        ListenIP=127.0.0.1   ➜ 这个前面的#号也删除 

        再开 zabbix 服务 还是开起不来.
        那就看第二个问题.
    👹 Can't connect to local MySQL server through socket '/var/lib/mysql/mysql.sock

      vi /var/lib/mysql/mysql.sock   丫的没有这个文件啊...
      谷歌了下发现
      vi /usr/local/zabbix-server/etc/zabbix_server.conf 
      📌📌 DBHost=localhost 这里的 localhost 必须换成 127.0.0.1
      虽然看着差不多.. 但是 localhost 和 127.0.0.1 还是有区别的!
      一个是域名,一个是IP地址.!!!!
      丫的 终于可以开起来啦!!! 不容易啊..
      zabbix-server 开起来还不够啊. 至少要开一个zabbix-agent 才能监控啊.
      我们将就下. 在服务器开 zabbix-agent吧.让服务器监控自己...




🔵 zabbix-agent 客户端设置

    配置zabbix_server配置文件
    vi /usr/local/zabbix-server/etc/zabbix_agentd.conf
    Server=127.0.0.1
    ServerActive=127.0.0.1
    Hostname=Zabbix server
hostmame : 用 hostname 命令一看就知道了.mail.0214.help


Server=192.168.137.110        #被动模式，允许哪台zabbix服务器连接，如有DNS解析可填主机名
ServerActive=192.168.137.110  #主动模式，允许向哪台zabbix服务器上报，如有DNS解析可填主机名
Hostname=192.168.137.101      #客户端本机IP，如有DNS解析可填主机名
UnsafeUserParameters=1        #允许用户自定义参数
EnableRemoteCommands=1        #允许执行远程命令


5.创建init服务
[root@zabbix-1 zabbix-2.4.4]# cp misc/init.d/fedora/core/zabbix_* /etc/init.d
[root@zabbix-1 zabbix-2.4.4]# sed -i ‘s/BASEDIR=\/usr\/local/BASEDIR=\/usr\/local\/zabbix/g’ /etc/init.d/zabbix_agentd

6.设置开机自启动
[root@web1-lnx zabbix-2.4.4]#chkconfig zabbix_agentd on
[root@zabbix-1 zabbix-2.4.4]# service zabbix_agentd start

Server = 监控服务器IP 
Hostnae= 本机的主机名 



    Server和ServerActive都指定zabbixserver的IP地址，
    如果服务器要监视自己 这个文件就不需要修改.默认值就可以了.

    不同的是，前者是被动后者是主动。
    Server这个配置是用来允许127.0.0.1这个ip来我这取数据。
    serverActive的127.0.0.1的意思是，客户端主动提交数据给他。明白了吗？
    为什么要分主动和被动？后续再来讨论这个问题！
    其他主机安装客户端记得添加zabbix用户。


启动 Zabbix 客户端  默认端口10050
🔅 /usr/local/zabbix-server/sbin/zabbix_agentd

本地浏览器上查看 还是有问题. 

还是有问题.  还是得看日志. LogFile=/tmp/zabbix_agentd.log

🔅 vi /tmp/zabbix_agentd.log
👹 failed to accept an incoming connection: connection from "45.78.0.14" rejected, allowed hosts: "127.0.0.1"

先看本地端口有没有开
zabbix agent  默认是 10050端口.
zabbix server 默认是 10051端口
nmap -p 10050 127.0.0.1  ➜  发现是开的.

还是那句话 端口开了说不定只能服务器本机访问的.外网用户是无法访问的.
不够怎样先关闭防火墙试试....
然后改 zabbix agent 的配置
vi /usr/local/zabbix-server/etc/zabbix_agentd.conf

Server=你的服务器地址
ServerActive=你的服务器地址
Hostname=你的客户端名称 用hostname 命令查看.

看来必须得加.. zabbix用户啊..
useradd zabbix . 有了啊...


👹active check configuration update from [127.0.0.1:10051] started to fail (cannot connect to [[127.0.0.1]:10051]: [111] Connection refused)





