🔵 简介
                                  ❤️❤️️❤️ Puppet 极品入门教程 ❤️❤️❤️
     http://www.zsythink.net/archives/category/%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3/puppet/

                ❗️❗️❗️❗️❗️❗️安装puppet-server 会自动安装 puppet-agent.❗️❗️❗️❗️❗️❗️
                ❗️❗️❗️❗️❗️❗️安装puppet-server 会自动安装 puppet-agent.❗️❗️❗️❗️❗️❗️
                          不管什么电脑要用puppet安装 puppet-server 就对了.
                                puppet-server 有很多版本 最新是 4.10
                                puppet-agent  有很多版本 最新是 1.10
                        最新版的puppet-server 最好连接最新版的 puppet-agent
                        高版本的puppet-server 可以连接低版本的 puppet-agent
                        低版本的puppet-server 不能连接高版本的 puppet-agent
                           所以: 服务器尽量安装最新版本. 客户端相对无所谓.

                        📌别在Mac上折腾 puppet-agent. 我反正半天没折腾成功📌
    🔸目的: 在无公网IP的Centos7虚拟机上搭建 puppet-server 服务器. 控制有公网IP的 vps.(puppet-agent)🔸




🔵 四个组件:
    🔸puppet-server    Puppet Server. 会自动安装 puppet-agent!!!
    🔸puppet-agent     多合一安装包.会安装 Puppet-agent, Ruby, Facter.等各种依赖.
    🔸puppetdb         数据库. 可以更好的使用 puppet.
    🔸facter           获取数据传给服务器.

        Puppet: C/S架构软件.
            📌服务器一般要安装 puppet-server 和 facter
            📌客户端一般要安装 puppet        和 facter


🔵 Puppet 工作流程

    puppet是批量管理服务器的, 比如要安装/输出/更新软件、新建/删除用户、启动/停止进程...
    所有的配置文件都是储存在服务器中.客户端每半小时连一次服务器. 看服务器上面的配置文件是否有更新.
    如果有更新.就下载配置文件.然后在本地执行

    客户端的facter 会获取客户端自己电脑的信息(如主机名，内存大小，ip地址等) 发送给服务器.
    服务器的facter 根据客户端主机名.在服务器配置文件中找到对应的配置.来分析客户端是否成功执行

    客户端和服务器之间的通信是基于SSL证书的.
    任何客户端都可以请求连接服务器. 但是只有在服务器同意后才可以和服务器通信!!

    puppet  会让系统保持在人们所期望的某种状态并一直维持下去.例如：
        保证某个文件一直存在， 如果该文件被删除了   puppet下次执行时（默认30分钟）会重新创建文件.
        保证ssh服务始终开启，  如果ssh服务被关闭了  puppet下次执行时（默认30分钟）会重启ssh服务.

    两者是通过 https 建立连接.  服务端端口默认 8140




🔵 储备知识 rpm

    RPM软件包的管理工具.最初是 red hat用来管理linux软件程序的,由于非常好用,被centos等系统采用了.

    🔸语法: rpm  ✚ 选项  ✚ 软件名.

    🔸选项:
        -i  显示套件的相关信息； 
        -v  显示指令执行过程； 
        -h  套件安装时列出标记； 
        -q  使用询问模式，当遇到任何问题时，rpm指令会先询问用户；
        -l  显示套件的文件列表；

    🔸常用选项组合
        rpm -ivh       安装软件
        rpm -ql        查看软件安装位置.
        rpm --force -i ❗️❗️❗️❗️强制安装❗️❗️❗️❗️
                正常一般添加对应源之后就可以用 yum 来安装对应的软件了.
                但是如果 rpm -ivh 安装过程报错. 最后yum install xxx 提示  command not found 
                就可以用强制安装!!!
                rpm -ivh http://yum.puppetlabs.com/puppetlabs-release-el-6.noarch.rpm
                    👹 package puppetlabs-release-22.0-2.noarch is already installed

                rpm --force -i http://yum.puppetlabs.com/puppetlabs-release-el-6.noarch.rpm
                这下就好了!!!  



🔵 Puppet 目录结构简介

    🔸Centos6    ls -1 /etc/puppet/     
        auth.conf         #定义puppet master的acl文件
        fileserver.conf   #定义puppet master文件服务器的配置文件
        manifests         #puppet脚本主文件目录，site.pp文件必须存在
        modules           #puppet模块目录
        puppet.conf       #puppet主配置文件
        ssl               #存放ssl证书的目录

🔵 相关资源

        ❗️❗️❗️❗️puppet官方yum源: https://yum.puppetlabs.com/
            不同的系统选择不同的源.  比如 centos6 和centps7 就有区别.
      
        puppet server 官网安装教程  https://docs.puppet.com/puppetserver/2.7/install_from_packages.html
        puppet agent  官网安装教程  https://docs.puppet.com/puppet/4.10/install_osx.html

🔵 常用命令

    🔅puppet help 查看各种命令.
    🔅puppet -V   查看版本.来确认是否安装成功.

    🔅puppet help agent                查看agent该子命令的详细用法.
        puppet agent -V/--version    查看版本
        puppet agent --verbose/-v    详细输出命令.  
        puppet agent --test / -t     测试连接.
        puppet agent --noop          模拟运行.
        puppet agent --debug/-d   
        puppet agent --certname <NAME>


    🔸证书相关命令:.
        puppet cert list                     列出未签名请求. (未签名最前面没有+号)
        puppet cert list --all               列出所有的签名. 包括已签名的(已签名最前面有个+号)
        puppet cert sign host2.example.com   给某个客户端请求进行签名(服务器上操作).
        puppet cert sign --all               给所有客户端请求进行签名(服务器上操作).



        ss -tlunp | grep puppet           查看puppet的端口 默认8140

        👁‍🗨 升级版本. 先卸载(yum remove puppet-server) 再安装



        🔅 vim /etc/puppet/puppet.conf     加入下面三行
              listen = true
              server = master.fansik.com
              runinterval = 30               
        🔅 /etc/init.d/puppet start        启动服务
        🔅 chkconfig puppet on             设置开机自启动



    puppet agent -v      ➜ verbose v模式.这样才会出现报错信息.才能对问题进行分析.
    puppet agent -d      ➜ 进入debug模式.. debug 排错!!! 比-v模式更加详细.







⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️❤️软件安装❤️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️
❤️CentOS6 安装 (详细)

    🔵依赖环境
        🔸 lsb_release -a                查看系统版本. ➜  Description:	CentOS release 6.9 (Final)
        🔸 uname -a                      查看系统是32位还是64位. 只有输出是x86_64 才是64位的. 其他都是32位的!!!!
        🔸 yum install ruby ruby-rdoc    安装ruby环境.
        🔸 添加puppet 的官方yum源.
            rpm -ivh https://yum.puppetlabs.com/puppetlabs-release-pc1-el-6.noarch.rpm
            ❗️❗️这个PC1源(Puppet Collections)才可以安装4.+版本 ❗️❗️

                    rpm -ivh http://yum.puppetlabs.com/puppetlabs-release-el-6.noarch.rpm
                    👁‍🗨 这个源最高只能安装 3.8.7的版本!! 别用这个源.

                    👹 package puppetlabs-release-22.0-2.noarch is already installed
                    如果出现 xxx is already installed 类似提示.  用 rpm --force -i  ✚ 网址 强制安装.
                    rpm --force -i http://yum.puppetlabs.com/puppetlabs-release-el-6.noarch.rpm
                    rpm --force -i https://yum.puppetlabs.com/puppetlabs-release-pc1-el-6.noarch.rpm

    🔵安装puppet-server
        🔸yum install puppetserver
            👁‍🗨 4+ 版本和3+的安装命令是不一样的 3+ 的好像是: yum install puppetmaster
            Server默认对内存要求高得2G... 256m的vps跑个客户端就可以了别跑服务端了...
        🔸 配置环境路径
                安装好后你会发现不能执行puppet命令!
                    👁‍🗨 如果你用的是 3.8.7 的那个源是可以直接使用puppet命令的.也就不需要配置环境路径. 
                正常 puppet agent -V 就能显示当前客户端版本的.
                📌Puppet4 的变化比较大. 
                    👁‍🗨 配置路径: /etc/pupperlabs
                    👁‍🗨 程序路径: /opt/puppetlabs
                直接去程序安装路径去看看能不能执行.
                cd /opt/puppetlabs/bin
                ./puppet agent -V
                    这下就显示出当前版本了!说明安装成功的.自己配下环境路径就好了. 
                    这一这个命令前的 ./ 这个表示当前文件夹!!!!

                下面我们手动把 /opt/puppetlabs/bin   这个路径添加到环境路径中!!
                以后任何位置都可以运行puppet命令了. 而不是必须cd到puppet的安装路径下才能运行puppet命令.
                环境路径 和你使用的sehll有关. 
                我用zsh 那么只要在  ~/.zshrc 这个文件里加下面行.然后重启shell生效.
                export PATH=/opt/puppetlabs/bin:$PATH
                在文件尾部添加一行 最简单的方法是使用echo. 当然你也可以手动vi添加.
                🔅 echo 'export PATH=/opt/puppetlabs/bin:$PATH' >> ~/.zshrc
                👁‍🗨 这里必须用 单引号. 单引号里面的内容才会一模一样的追加到文件中.不然$PATH这个变量会展开.
                👁‍🗨 添加变量后记得重启shell. 服务器的话.断开ssh 重新连就可以了.

                
❤️ CentOS 7x64 安装配置 (简单)

    🔸 yum install ruby ruby-rdoc             ➜ 安装ruby环境.
    🔸 rpm -ivh https://yum.puppetlabs.com/puppetlabs-release-pc1-el-6.noarch.rpm   添加puppet 的官方yum源.
    🔸 yum install puppetserver               ➜ 安装puppet-server 
    🔸  vi /etc/sysconfig/puppetserver        ➜ 修改内存要求.   
        JAVA_ARGS="-Xms2g -Xmx2g"             ➜ 这行的2g改掉如:
        JAVA_ARGS="-Xms256m -Xmx256m"
    🔸 环境路径(按bash选一个就可以)
        echo 'export PATH=/opt/puppetlabs/bin:$PATH' >> ~/.bash_profile
        echo 'export PATH=/opt/puppetlabs/bin:$PATH' >> ~/.zshrc
    🔸 重启shell
    🔸 puppetserver start                     ➜ 启动puppet-server 
    🔸 service puppetserver status            ➜ 查看puppetserver 运行状态.  
    🔸 namp 127.0.0.1                         ➜ 查看端口是否正常开启
                                              ➜ nmap 默认只扫描 1000之内的端口啊.
                                              ➜ 记得加参数!!!    nmap -p 8140 127.0.0.1  
                                              ➜ 或者用 netstat -nlatp | grep 8140



⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️❤️ FRP 内网穿透设置❤️ ️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️
    角色           系统             IP地址    安装软件           主机名.
    puppet-server  Centos7(虚拟机)  内网IP    puppet-server      VM-C7     
    puppet-agent   Centos6(VPS)     公网IP    puppwt-agent       mail.0214.help 

要使用 puppet. 必须保证 双方能用域名互相解析到. 
因为 puppet 是通过  VM-C7 和 mail.0214.help  主机名来互相交流的!

🔵 如果 puppet-server 和 puppet-agent 都在一个局域网内. 比如:
    puppet-server 的IP地址是 192.168.1.1, 主机名是 master
    puppet-agent  的IP地址是 192.168.1.2, 主机名是 client

    那么域名解析非常简单.
        只要在puppet-server 的hosts文件添加一行: 192.168.1.2  client
            添加后你去puppet-server 电脑开终端 ping client 就是ping 192.168.1.2

        只要在puppet-agent 的hosts文件添加一行: 192.168.1.1  master
            添加后你去puppet-agent 电脑开终端 ping master 就是ping 192.168.1.1

        这就是域名解析. 也就是把一个名字 对应到一个IP上. 就这么简单.

🔵 如果 puppet-server 和 puppet-agent 不在一个局域网内.比如:
    puppet-server 的内网IP地址是 192.168.1.1,  主机名是 VM-C7
    puppet-agent  的公网IP地址是 23.105.192.96 主机名是 mail.0214.help
    要实现互相解析就需要对网络 和 puppet 有点了解了. 需要借助内网穿透工具.推荐用frp. 
    两台puppet表面上是通过 域名来互相交流的. 实际上是通过IP来互相交流的.
    用域名只是为了方便人类记忆. 好比 姓名和身份证号码. 肯定是姓名容易记啊..

    再深入一点. 服务器可以同时运行很多软件.一般一个服务器也就一个外网IP.
    电脑上的每个软件只用了IP的几个端口而已.
    比如网页:   http 的80端口、https 的443端口.
    比如puppet: puppet-server 的8140端口. puppet-agent 的8139端口.

    其实 puppet-server 和 puppet-agent 之间用的是 http 协议.
    puppet-agent 通过电脑上的8139端口 发消息给 puppet-server 上的8140端口.
    既然端口是确定的. 我们不用管.那么我们只要解决IP问题就好了. 
    puppet-agent 服务器是本身带有公网IP的. 任何电脑要解析到puppet-agent很简单.  解析可以理解成连接. 比如ssh连接.
    puppet-server 是内网电脑.没有IP的.     任何电脑要解析到puppet-server就很难. 用了 frp就很简单!!!
    frp 原理这里不说. 自己看 frp.txt去.


🔵 FRP服务器设置 (Centos6 VPS 公网IP: 23.105.192.96)
    vi frps.ini                 ➜ 编辑frp服务器配置文件,添加下面三行: 
    [vm-centos7-puppetserver]   ➜ 模块名字. 名字任意取.但是必须和frp客户端配置文件中的模块名一样.
    auth_token = 123            ➜ 密码. 服务器和客户端 交流要先对比密码的. 双方密码一直才可以成功连上服务器.
    listen_port = 8140          ➜ 这个就是重点了. 这个是frp服务器端口.
                                ➜ 如果有人访问23.105.192.96:8140 首先是连接到frp服务器这台电脑.
                                ➜ 然后frp服务器就会把这个端口的所有数据转发给我们等下就去设置的客户端.
                                ➜ 文件编辑好后需要重启frp服务.

    🔸 pidof frps                    ➜ 找出frps进程: 
    🔸 kill xxx                      ➜ 杀死frps进程. 也就是停止程序了.
    🔸 ./frps -c ./frps.ini          ➜ 测试启动. 有错误会报错! 没报错再用下面的命令进行后台长期运行..
    🔸 nohup ./frps -c ./frps.ini &  ➜ 后台运行.断开ssh也没关系.



🔵 FRP客户端设置 (puppet-server Centos7 虚拟机)
    🔸下载对应的客户端 wget https://github.com/fatedier/frp/releases/download/v0.9.3/frp_0.9.3_linux_386.tar.gz
    🔸 解压文件        tar -xzf 
    🔸 vi frpc.ini  编辑frp客户端配置文件
    [common]                       ➜ 别动; 连接FRP服务器的模块名称.
    server_addr = 23.105.192.96    ➜ 修改; FRP服务器IP    
    server_port = 7000             ➜ 不管; FRP服务器端口. 

    auth_token = 123               ➜ 不管
    privilege_token = 12345678     ➜ 不管

    [vm-centos7-puppetserver]      ➜ 重点! 这个需要和FRP服务器上的模块名对应.
    local_port = 8140              ➜ 重点! 任何数据访问服务器上的 8140端口 23.105.192.96:8140 
                                        FRP服务器 就会把数据转发到这台电脑. 但是这台电脑有很多端口. 
                                        local_port=8140的意思就是 转发到8140这个端口
                                        现在别的iFFmpeg按钮表面上是访问的 23.105.192.96:8140 
                                        其实经过frp服务器在中转后 实际就变成了访问 puppet-server的8140端口了.
                                        也就是别的电脑想要连接到 pupper-server.
    🔸nohup ./frpc -c ./frpc.ini &  ➜ 后台启动frp 客户端







⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️ 域名解析 ⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️

🔸 关闭 SELINUX
    Security-Enhanced Linux的缩写，是一种非常安全的LINUX模式。
    基本上用户得不到什么权限在这个系统下面。
    🔅 usr/sbin/sestatus -v                       ➜ 查看当前SELINUX状态. 
        vi /etc/selinux/config                    ➜ 修改这个文件来永久关闭SELINUX
        将SELINUX=enforcing改为SELINUX=disabled   ➜ 修改后重启电脑.


🔸 新手关闭防火墙.

🔸 时间设置
       Puppet的master节点的时间必须设置准确，因为他将用于证书签发.尽可能的使用NTP.

🔸Cent0s7 更改主机名:
        hostname                                      ➜ 查看当前主机名.
        sudo hostnamectl --static set-hostname VM-C7  ➜ 永久更改主机名成VM-C7


🔸puppet-agent域名解析
    vi /etc/hosts         
    23.105.192.96 VM-C7 ➜  添加这行就可以了. 其实你不用管端口的 
                        ➜ 这个电脑运行的是puppet-agent 那么它肯定是去连接服务器的.肯定是去连接8140端口的.
                        ➜ 23.105.192.96:8140 端口的所有数据.都会被frp服务器.转个puppet-server的8140端口.

🔸 编辑puppet-agent配置文件. 添加下面两行.
    vi /etc/puppetlabs/puppet/puppet.confi
    [agent]
    server = VM-C7      ➜ 这个就是你要连接的 puppet-server 的主机名/域名

🔸 puppet-agent申请连接服务器
    🔅 puppet agent --test
    Info: Creating a new SSL key for mail.0214.help

    puppet 为了信息安全. 双方采用了SSL协议. 也就是https. 需要用到证书!
    客户端运行 就自动会向服务器申请建立连接. 这时候要去服务器同意对方进行连接.
    同意之后 服务器和客户端就会长期保持通信(客户端每半小时连一次服务器)!!!


🔸 puppet-server 服务器查看 签名请求
    🔅puppet cert list
      "mail.0214.help" (SHA256) 6E:3F:48:F6:F1:52:18:30:F8:DD:2F:D3:7E:BA:C1:2E:1E:89:8A:0D:37:96:DF:E3:F5:79:A0:7F:85:5C:28:97
      出现一个 前面没带加号的 就说明有客户端想要连服务器.如果你同意对方连接 就需要签名.

🔸 puppet-server 对客户端请求进行签名
    puppet cert sign mail.0214.help
    Signing Certificate Request for:
    "mail.0214.help" (SHA256) 6E:3F:48:F6:F1:52:18:30:F8:DD:2F:D3:7E:BA:C1:2E:1E:89:8A:0D:37:96:DF:E3:F5:79:A0:7F:85:5C:28:97
    Notice: Signed certificate request for mail.0214.help
    Notice: Removing file Puppet::SSL::CertificateRequest mail.0214.help at '/etc/puppetlabs/puppet/ssl/ca/requests/mail.0214.help.pem'


🔸puppet-server 查看所有证书
    ➜  requests puppet cert list -all
    + "mail.0214.help" (SHA256) 4D:01:04:D7:4B:C8:75:D6:C2:D5:63:BA:93:46:C2:E1:D9:82:D6:97:AA:AC:A8:50:69:9F:6A:A8:67:27:67:F2
    + "mail.0214.live" (SHA256) D3:D7:DB:74:E6:53:CC:0F:EE:55:83:5E:65:A5:9B:32:4B:D6:9F:E5:DA:D1:50:67:88:31:3C:44:EE:C0:EE:92


🔸puppet-server 失效某证书  puppet cert -revoke mail.0214.live
🔸puppet-server 删除某证书  puppet cert --clean mail.0214.live
    证书签名的过期或删除需要重启puppetmaster服务。


🔸puppet-agent 证书操作.
    /etc/puppetlabs/puppet/ssl
    📌如果客户端连接服务器出问题. 清空ssl文件夹 用puppet agent --test 重新申请证书.






⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️------⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️⬛️














































